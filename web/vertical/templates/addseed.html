{% load static %}
{% load staticfiles %}

<!DOCTYPE html>
<html lang="zh-CN" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link href="{{ STATIC_URL }} /static/css/bootstrap.min.css" rel="stylesheet">
    <!--<link rel="stylesheet" href="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/css/bootstrap.min.css">-->
    <!--<script src="http://cdn.static.runoob.com/libs/jquery/2.1.1/jquery.min.js"></script>-->
    <!--<script src="http://cdn.static.runoob.com/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div class="container">
    <h1>添加种子数据</h1>
    <!--输入框-->
    <!--<form>-->
    <!--<div class="form-group row">-->
    <!--<label for="first_name" class="col-xs-3 col-form-label mr-2">First Name</label>-->
    <!--<div class="col-xs-9">-->
    <!--<input type="text" class="form-control" id="first_name" name="first_name">-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="form-group row">-->
    <!--<label for="last_name" class="col-xs-3 col-form-label mr-2">Last Name</label>-->
    <!--<div class="col-xs-9">-->
    <!--<input type="text" class="form-control" id="last_name" name="last_name">-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="form-group row">-->
    <!--<div class="offset-xs-3 col-xs-9">-->
    <!--<button type="submit" class="btn btn-primary">Submit</button>-->
    <!--</div>-->
    <!--</div>-->
    <!--</form>-->
    <form autocomplete="on">
        {% csrf_token %}
        <div class="seed-info">
            <div class="seed-name">
                <span>种子名称</span>
                <input type="text" class="action-name input-group-sm" value="">
            </div>
            <div class="seed-desc">
                <span>种子描述</span>
                <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60"></textarea>
            </div>
            <div class="seed-run-interval">
                <span>运行间隔</span>
                <input type="text" class="action-name input-group-sm" value="">
            </div>
        </div>
        <br>
        <p>设置</p>
        <div class="seet-setting">
            <div class="seed-setting-header">
                <span>HEADER</span>
                <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60">{}</textarea>
            </div>
            <div class="seed-setting-header">
                <span>User-Agent</span>
                <select class="us-type">
                    <option value="pc_rand">pc_rand</option>
                    <option value="mobild_rand">mobild_rand</option>
                    <option value="weixin">weixin</option>
                </select>
            </div>
            <div class="seed-setting-header">
                <span>Cookie 支持</span>
                <select class="cookie-type">
                    <option value="A 站点">A 站点</option>
                    <option value="B 站点">B 站点</option>
                    <option value="C 站点">C 站点</option>
                </select>
            </div>
        </div>
        <br>
        <div class="seed-init bg-secondary">
            <div class="action-name">
                <span>名称</span>
                <input type="text" class="action-name input-group-sm" value="" autocomplete="off">
            </div>
            <div class="seed-type">
                <span>初始链接类型</span>
                <select class="cookie-type">
                    <option value="list">list</option>
                    <option value="template">template</option>
                    <option value="pyfunc">pyfunc</option>
                </select>
            </div>
            <div class="seed-init-url">
                <span>初始种子链接</span>
                <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60"></textarea>
                <span class="bg-danger">模板信息使用 jinja2  可以方法, 方法名是:init_urls_func</span>
            </div>
            <div class="action-extract">
                <div class="extract-type">
                    <span>提取 type</span>
                    <select class="extract-type">
                        <option value="None">None</option>
                        <option value="xpath">xpath</option>
                        <option value="json">json</option>
                        <option value="re">re</option>
                        <option value="pyfunc">pyfunc</option>
                        <option value="saveall">saveall</option>
                    </select>
                </div>
                <div>
                    <span>提取数据</span>
                    <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60">{}</textarea>
                    <span class="bg-danger">现在输入 json 或者方法,方法名是：extract_fields_func</span>
                </div>
            </div>
        </div>

        <div class="page-actions" id="page-actions">
            <ul class="page-action bg-warning">
                <li class="action">
                    <!--<div class="action-name">-->
                    <!--<span>名称</span>-->
                    <!--<input type="text" class="action-name input-group-sm" value="" autocomplete="off">-->
                    <!--</div>-->

                    <div class="action-next bg-secondary">
                        <span>下一步动作</span>
                        <ul class="page-next-action">
                            <div class="action-name">
                                <span>名称</span>
                                <input type="text" class="action-name input-group-sm" value="" autocomplete="off">
                            </div>
                            <div class="next-temp">
                                <span>URL 模板</span>
                                <input type="text" class="input-group-sm" size="65" value=""/>
                                <span class="bg-danger">模板信息使用 jinja2  </span>
                            </div>
                            <div class="next-regex">
                                <span>URL 正则</span>
                                <input type="text" class="" size="65" value=""/>
                                <span class="bg-danger">主要用来过滤不需要抓取 URL</span>
                            </div>
                            <div class="extract-type">
                                <span>提取 type</span>
                                <select class="extract-type">
                                    <option value="None">None</option>
                                    <option value="xpath">xpath</option>
                                    <option value="json">json</option>
                                    <option value="re">re</option>
                                    <option value="pyfunc">pyfunc</option>
                                    <option value="saveall">saveall</option>
                                </select>
                            </div>
                            <div class="extract-fields">
                                <span>提取下一步的模板数据</span>
                                <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60">{}</textarea>
                                <span class="bg-danger">现在输入 json 或者方法,方法名是extract_fields_func</span>
                            </div>
                            <div class="action-sample">
                                <span>示例链接</span>
                                <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60"></textarea>
                            </div>
                            <div class="action-extract bg-info">
                                <div class="extract-type">
                                    <span>提取 type</span>
                                    <select class="extract-type">
                                        <option value="None">None</option>
                                        <option value="xpath">xpath</option>
                                        <option value="json">json</option>
                                        <option value="re">re</option>
                                        <option value="pyfunc">pyfunc</option>
                                        <option value="saveall">saveall</option>
                                    </select>
                                </div>
                                <div>
                                    <span>提取数据</span>
                                    <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60">{}</textarea>
                                    <span class="bg-danger">现在输入 json 或者方法,方法名是：extract_fields_func</span>
                                </div>
                            </div>
                            <div class="action-remove-self">删除自己</div>
                            <div class="action-add-child">添加子节点</div>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>

        <div class="add-page-action"><i class="fa fa-plus"></i>添加 Page Action</div>
        <div class="test-parse-data"><i class="fa fa-plus"></i>测试提取数据</div>
    </form>

    <button type="button" class="btn btn-default">取消</button>
    <button type="button" class="btn btn-primary save-config">保存</button>
    <button type="button" class="btn btn-primary">调试</button>
</div>

<script type="text/javascript" src="{{ STATIC_URL }}/static/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}/static/js/bootstrap.js"></script>
    
<script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.templates/beta1/jquery.tmpl.js"></script>

<script>
    var temp = '<div class="action-next bg-secondary">\n' +
        '                        <span>下一步动作</span>\n' +
        '                        <ul class="page-next-action">\n' +
        '                            <div class="action-name">\n' +
        '                                <span>名称</span>\n' +
        '                                <input type="text" class="action-name input-group-sm" value="" autocomplete="off">\n' +
        '                            </div>\n' +
        '                            <div class="next-temp">\n' +
        '                                <span>URL 模板</span>\n' +
        '                                <input type="text" class="input-group-sm" size="65" value=""/>\n' +
        '                                <span class="bg-danger">模板信息使用 jinja2  </span>\n' +
        '                            </div>\n' +
        '                            <div class="next-regex">\n' +
        '                                <span>URL 正则</span>\n' +
        '                                <input type="text" class="" size="65" value=""/>\n' +
        '                                <span class="bg-danger">主要用来过滤不需要抓取 URL</span>\n' +
        '                            </div>\n' +
        '                            <div class="extract-type">\n' +
        '                                <span>提取 type</span>\n' +
        '                                <select class="extract-type">\n' +
        '                                    <option value="None">None</option>\n' +
        '                                    <option value="xpath">xpath</option>\n' +
        '                                    <option value="json">json</option>\n' +
        '                                    <option value="re">re</option>\n' +
        '                                    <option value="pyfunc">pyfunc</option>\n' +
        '                                    <option value="saveall">saveall</option>\n' +
        '                                </select>\n' +
        '                            </div>\n' +
        '                            <div class="extract-fields">\n' +
        '                                <span>提取下一步的模板数据</span>\n' +
        '                                <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60">{}</textarea>\n' +
        '                                <span class="bg-danger">现在输入 json 或者方法,方法名是extract_fields_func</span>\n' +
        '                            </div>\n' +
        '                            <div class="action-sample">\n' +
        '                                <span>示例链接</span>\n' +
        '                                <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60"></textarea>\n' +
        '                            </div>\n' +
        '                            <div class="action-extract bg-info">\n' +
        '                                <div class="extract-type">\n' +
        '                                    <span>提取 type</span>\n' +
        '                                    <select class="extract-type">\n' +
        '                                        <option value="None">None</option>\n' +
        '                                        <option value="xpath">xpath</option>\n' +
        '                                        <option value="json">json</option>\n' +
        '                                        <option value="re">re</option>\n' +
        '                                        <option value="pyfunc">pyfunc</option>\n' +
        '                                        <option value="saveall">saveall</option>\n' +
        '                                    </select>\n' +
        '                                </div>\n' +
        '                                <div>\n' +
        '                                    <span>提取数据</span>\n' +
        '                                    <textarea type="text" class="" style="white-space:nowrap; overflow:scroll; vertical-align: top;" cols="60">{}</textarea>\n' +
        '                                    <span class="bg-danger">现在输入 json 或者方法,方法名是：extract_fields_func</span>\n' +
        '                                </div>\n' +
        '                            </div>\n' +
        '                            <div class="action-remove-self">删除自己</div>\n' +
        '                            <div class="action-add-child">添加子节点</div>\n' +
        '                        </ul>\n' +
        '                    </div>';

    var temp_data = '<ul class="page-action bg-warning">\n' +
        '                <li class="action">\n' +
        temp +
        '                </li>\n' +
        '            </ul>';

    $(".add-page-action").click(function () {
        $('#page-actions').append(temp_data)
    });


    $(document).on('click', ".action-add-child", function (event) {
        $(this).parent().append(temp_data);
        event.stopPropagation()
    });

    $(document).on('click', ".action-remove-self", function (event) {
        $(this).parent().remove();
        event.stopPropagation()
    });

    $(".test-parse-data").click(function () {
        var page_actions = $(".page-actions"); // 获取到跟节点 page-actions

        var page_action_item = page_actions.children('.page-action'); // 获取到第一层的 page-action 列表
        var add_page_datas = parse_page_action_list(page_action_item);
        console.log(add_page_datas);
    });

    function parse_page_action_list(page_action_item) {
        var page_datas = [];
        page_action_item.each(function (i, item) {  // 遍历子节点，获取输入数据
            var data = {};
            var obj = $(item);
            var action = obj.find('.action');
            data['action_name'] = action.find('.action-name').find('input').val(); // name
            //action-extract
            // data['extract'] = {};
            // data['extract']['type'] = action.find('.action-extract').find(':selected').text();
            // data['extract']['fields'] = action.find('.action-extract').find('textarea').val();
            data['next'] = {};
            var action_next = action.find('.action-next');  // next
            // data['next']['type'] = action_next.find('select').find(":selected").text();
            data['next']['url_temp'] = action_next.find('.next-temp').find('input').val();
            data['next']['url_regex'] = action_next.find('.next-regex').find('input').val();
            // next_field  todo... 现在需要输入 json 格式
            data['next']['type'] = action_next.find('.extract-type').find(':selected').val();
            // data['next']['fields'] = JSON.parse(action_next.find('.extract-fields').find('textarea').val());
            data['next']['fields'] = action_next.find('.extract-fields').find('textarea').val();
            // sample
            data['next']['sample_urls'] = action.find('.action-sample').find('textarea').val().split('\n');
            var child_action_item = action.find(".page-action");

            data['extract_fields'] = {};
            data['extract_fields']['type'] = action.find('.action-extract').find(':selected').val();
            data['extract_fields']['fields'] = action.find('.action-extract').find('textarea').val();

            var add_pages = parse_page_action_list(child_action_item);
            if (add_pages.length > 0) {
                data['add_pages'] = add_pages;
            }
            page_datas.push(data);
        });
        return page_datas;
    }

    $('.save-config').on('click', function (event) {
        var seed_init = $('.seed-init');
        var name = seed_init.find(".seed-name").find("input").val();  //
        var description = seed_init.find(".seed-desc").find("textarea").val(); //
        var run_interval = seed_init.find(".seed-run-interval").find("input").val(); //
        var init_type = seed_init.find(".seed-type").find('select').find(":selected").text();
        var init_info = seed_init.find(".seed-init-url").find("textarea").val(); //
        var extract_type = seed_init.find(".action-extract").find(":selected").text(); //
        var extract_info = seed_init.find(".action-extract").find("textarea").val(); //
        // 首先获取初始用户的提取数据

        // 再乡下递归到下一步动作
        var page_actions = $(".page-actions"); // 获取到跟节点 page-actions //
        var page_action_item = page_actions.children('.page-action'); // 获取到第一层的 page-action 列表
        var add_page_datas = parse_page_action_list(page_action_item);

        if (init_type === 'list') {
            init_info = init_info.split('\n')
        }

        var rule_data = {
            "seed_init": {
                "init_type": init_type,
                "init_info": init_info,
                "extract_fields": {
                    "type": extract_type,
                    "fields": extract_info
                },
                "add_pages": add_page_datas
            }
        };
        var data = {
            // 'seed_id': 3,
            'name': name,
            'description': description,
            'run_interval': run_interval,
            'rule_data': JSON.stringify(rule_data)
        };
        console.log(data);
        $.ajax({
            type: "POST",
            url: '/vertical/addseed/',
            data: data,
            dataType: "json",
            success: function (body) {
                console.log(body);
                alert('成功保存');
            }
        });
    });
</script>
</body>
</html>